
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>React v16 changes - blog.koba04.com</title>
  <meta name="author" content="koba04">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/images/favicon.ico" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="blog.koba04.com" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <script src="/js/application.js"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <meta property="og:title" content="React v16 changes - blog.koba04.com" />
<meta property="og:description" content="" />
<meta property="og:url" content="http://blog.koba04.com/post/2017/09/27/react-v16-changes/" />
<meta property="og:image" content="https://avatars.githubusercontent.com/u/250407" />
<meta property="og:author" content="koba04" />
<meta property="og:site_name" content="blog.koba04.com" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="fb:app_id" content="346463362115366" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8875970-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <div class="nav-title"><a href="/">blog.koba04.com</a></div>
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/koba04" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    
    
    <li><a href="http://twitter.com/koba04" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    
    
    
    <li><a href="http://d.hatena.ne.jp/koba04/">OldBlog</a></li>
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    React v16 changes
	<h5>








  


<i class="icon-calendar-empty"></i> <time datetime="2017-09-27T16:34:07+09:00" pubdate data-updated="true">Sep 27<span>th</span>, 2017</time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p>Reactのv16がリリースされたので、変更点などを整理したいと思います。</p>

<ul>
<li><a href="https://facebook.github.io/react/blog/2017/09/26/react-v16.0.html">https://facebook.github.io/react/blog/2017/09/26/react-v16.0.html</a></li>
<li><a href="https://code.facebook.com/posts/1716776591680069/react-16-a-look-inside-an-api-compatible-rewrite-of-our-frontend-ui-library/">https://code.facebook.com/posts/1716776591680069/react-16-a-look-inside-an-api-compatible-rewrite-of-our-frontend-ui-library/</a></li>
</ul>


<p>React v16やReact Fiberについては、下記で書いたりもしているのでそちらも参考にしてみてください。</p>

<ul>
<li><a href="http://blog.koba04.com/post/2017/04/25/a-state-of-react-fiber/">React Fiber現状確認</a></li>
<li><a href="https://speakerdeck.com/koba04/capability-of-react-fiber">Capability of React Fiber</a></li>
<li><a href="https://speakerdeck.com/koba04/react-v16-and-beyond-react-fiber">React v16 and beyond React Fiber</a></li>
<li><a href="https://html5experts.jp/shumpei-shiraishi/23265/">ReactはなぜFiberで書き直されたのか？Reactの課題と将来像を探る</a></li>
</ul>


<!-- more -->


<h2>新機能</h2>

<h3>render関数から文字列や配列を直接返せるように</h3>

<p>地味に嬉しい機能ですね。これまでは無駄にspanやdivで囲むしかなかったのが、直接文字列や配列を返すことができるようになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// 文字列を直接返す</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">DisplayName</span> <span class="o">=</span> <span class="p">({</span><span class="nx">user</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span> <span class="p">(</span><span class="err">@</span><span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">})</span><span class="err">`</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 配列</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Row</span> <span class="o">=</span> <span class="p">({</span><span class="nx">children</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">children</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/tr&gt;;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Columns</span> <span class="o">=</span> <span class="p">({</span><span class="nx">items</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span><span class='line'>  <span class="nx">items</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">td</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">i</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">item</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/td&gt;)</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">Row</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">Columns</span> <span class="nx">items</span><span class="o">=</span><span class="p">{[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">]}</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/Row&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>配列を返す場合は、<code>key</code>を必ずつける必要があります。
それをJSXのSyntaxレベルでサポートするという議論もあったりします。</p>

<ul>
<li><a href="https://github.com/facebook/jsx/issues/84">https://github.com/facebook/jsx/issues/84</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">foo</span><span class="o">&lt;</span><span class="err">/li&gt;,</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">bar</span><span class="o">&lt;</span><span class="err">/li&gt;,</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="mi">3</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">baz</span><span class="o">&lt;</span><span class="err">/li&gt;,</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="err">↓↓↓</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// こんな感じで書けるようにしたいという議論</span>
</span><span class='line'><span class="o">&lt;&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="nx">foo</span><span class="o">&lt;</span><span class="err">/li&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="nx">bar</span><span class="o">&lt;</span><span class="err">/li&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="nx">baz</span><span class="o">&lt;</span><span class="err">/li&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Error Boundaries</h3>

<p>子のComponentのrender関数やライフサイクルメソッドで起きたエラーを、<code>componentDidCatch</code>というライフサイクルメソッドでキャッチできるようになります。
これによって、エラーが起きたことをユーザーに伝えたり、エラーリポートのサービスに送信できるようになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Child</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 〜 is not a functionみたいなエラーでも同様</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Something went wrong!!&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Child</span><span class="o">!&lt;</span><span class="err">/p&gt;;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">App</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">error</span><span class="o">:</span> <span class="kc">null</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">componentDidCatch</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">error</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">componentStack</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// Something went wrong!! </span>
</span><span class='line'>    <span class="c1">// in Child (created by App)</span>
</span><span class='line'>    <span class="c1">// in section (created by App)</span>
</span><span class='line'>    <span class="c1">// in App</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">section</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span> <span class="o">?</span> <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="err">エラーが発生しました</span><span class="o">&lt;</span><span class="sr">/p&gt; : &lt;Child /</span><span class="o">&gt;</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/section&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記のように、componentDidCatchの引数には、Errorオブジェクト以外に<code>info</code>というオブジェクトを受け取ります。infoは今のところ<code>componentStack</code>のプロパティしか持っていません。<code>componentStack</code>には、Compnentのスタックトレースが文字列で入っています。したがって、これをエラーと一緒に送信すると、どこのComponentでどのエラーが発生したのかがわかります。</p>

<p><strong>Error Boundariesの対象になるのは、render関数とライフサイクルメソッドの中のエラーだけです。</strong>なので、イベントハンドラーの中で起きたエラーや、ライフサイクルメソッドの中での非同期処理（HTTP Requestなど)で起きたエラーは対象になりません。</p>

<p>また、もう一点、上記のError Boundariesの対象となるエラーに対する扱いが変更されています。</p>

<p>v15までは、エラーが発生したらそこで処理が中断されていました。したがって、途中のComponentのrenderで処理が止まるなど、不整合なViewをユーザーに見せてしまう可能性がありました。</p>

<p>v16では、エラーが発生すると、ReactDOM.renderで指定したRoot Containerから全てアンマウント（DOMから削除）されるようになります。
それを避けたい場合には、上記の例のようにcomponentDidCatchを定義してsetStateするなどしてエラー用の表示を行う必要があります。
なので、親のComponentでcomponentDidCatchを定義したり、componentDidCatchを定義したComponentでアプリケーション全体のComponentをラップしておくと安心かと思います。</p>

<h3>Portals</h3>

<p><code>ReactDOM.createPortal</code>というAPIが追加されました。</p>

<ul>
<li><a href="https://facebook.github.io/react/docs/portals.html">https://facebook.github.io/react/docs/portals.html</a></li>
</ul>


<p>これは、Componentツリーの外側に対するrenderをComponentツリーの一部として扱えるようにする機能です。
文字だけで書くとわかりにくいので例として、どこかアプリケーションの外側にモーダル用のDOMがあって、アプリケーションのStateによってモーダルを表示したい場合を考えてみます。</p>

<p>Portalを使わずに書くと、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">App</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">componentDidUpdate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.modal-container&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">modal</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">Modal</span>
</span><span class='line'>                    <span class="nx">type</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">modal</span><span class="p">}</span>
</span><span class='line'>                    <span class="nx">onClose</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span>
</span><span class='line'>                            <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">modal</span><span class="o">:</span> <span class="kc">null</span><span class="p">}),</span>
</span><span class='line'>                            <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">unmountComponentAtNode</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}}</span>
</span><span class='line'>                <span class="o">&gt;</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ....</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>とcomponentDidUpdateやcomponentDidMountのライフサイクルメソッドの中で扱う形になりますが、Portalを使うと、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">App</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">section</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">Contents</span> <span class="o">/&gt;</span>
</span><span class='line'>            <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">modal</span> <span class="o">&amp;&amp;</span> <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">createPortal</span><span class="p">(</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">Modal</span>
</span><span class='line'>                    <span class="nx">type</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">modal</span><span class="p">}</span>
</span><span class='line'>                    <span class="nx">onClose</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">modal</span><span class="o">:</span> <span class="kc">null</span><span class="p">}))</span>
</span><span class='line'>                    <span class="p">}}</span>
</span><span class='line'>                <span class="o">/&gt;</span><span class="p">,</span>
</span><span class='line'>                <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.modal-container&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)}</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="err">/section&gt;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>というように、render関数の中に書くことが出来ます。
この場合Modalは、Contentsの隣に配置されたComponentと同様に処理されます。</p>

<p>なので、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">section</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">)}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">createPortal</span><span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Portal</span><span class="o">&lt;</span><span class="err">/p&gt;,</span>
</span><span class='line'>            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.somewhere&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)}</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/section&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>とあった場合、<code>&lt;p&gt;Portal&lt;/p&gt;</code>をクリックした場合にも、<code>cosole.log('click')</code>が呼ばれます。</p>

<h3>ServerSide Rendering</h3>

<p>サーバーサイドレンダリングは完全にリライトされました（既存の実装をベースに）。
これまでは、クライアントでのDOM構築と同じ流れでHTMLを構築していたのですが、下記の1ファイルに切り離されました。</p>

<ul>
<li><a href="https://github.com/facebook/react/blob/master/src/renderers/shared/server/ReactPartialRenderer.js">https://github.com/facebook/react/blob/master/src/renderers/shared/server/ReactPartialRenderer.js</a></li>
</ul>


<p>これにより、無駄な処理が減ったことによる高速化やStreamサポートが簡単に行えるようになりました。
また、独立したファイルになったことで、今後のパフォーマンスチューニングもやりやすくなったと思います。</p>

<p>その他サーバーサイドレンダリングに対する変更は、Node Stream対応のAPIの追加とHydarationの方法の変更です。</p>

<p>Node Streamの対応については、<code>renderToNodeStream</code>と<code>renderToStaticNodeStream</code>のAPIが追加されたので、それを使うだけです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">ReactDOMServer</span> <span class="nx">from</span> <span class="s1">&#39;react-dom/server&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Hello</span> <span class="nx">Stream</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ReactDOMServer</span><span class="p">.</span><span class="nx">renderToNodeStream</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">);</span>
</span><span class='line'><span class="c1">// &lt;div data-reactroot=&quot;&quot;&gt;&lt;p&gt;Hello Stream!&lt;/p&gt;&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">renderToStaticNodeStream</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">);</span>
</span><span class='line'><span class="c1">// &lt;div&gt;&lt;p&gt;Hello Stream!&lt;/p&gt;&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hydrationの方法の変更については、クライアント側の変更とバリデーションロジックの変更があります。</p>

<p>ここでいうHydrationとは、サーバーサイドレンダリングで返したHTMLが生成したDOM要素を、クライアント側でのレンダリング時に再利用することを指します。</p>

<p>クライアント側でのAPIの変更については、ReactDOM.renderの代わりに<code>ReactDOM.hydrate</code>という専用のAPIを使うようになります。
v16の段階では、ReactDOM.renderによるHydrationもサポートされますが、将来的に廃止される予定です。</p>

<p><del>ちなみに、renderToNodeStreamとrenderToStaticNodeStreamによる出力の違いは、Rootの要素に<code>data-reactroot</code>があるかないかの違いだけです。このdata-reactrootはReactDOM.renderでHydrationするかどうかの判定に使われているだけです。
なので、将来的にはどちらか1つのAPIだけになると思います。ReactDOM.hydrateを使う場合は、renderToStaticNodeStreamで生成したHTMLに対してもHydration出来ます。</del></p>

<hr />

<p><strong>[2017/10/01:訂正]</strong></p>

<p>renderToNodeStreamとrenderToStaticNodeStreamによる出力の違いは、Rootの要素に<code>data-reactroot</code>以外にも、変数部分を識別するためのコメントノードの差し込みがあります。
したがって、Hydrationする場合にはrenderToNodeStreamを、それ以外の場合はrenderToStaticNodeStreamという使い分けになります。</p>

<hr />

<p>Hydrationの方法については、v15まではrenderToStringで生成したHTMLの<code>data-react-check-sum</code>という属性につけられたチェックサムを使い、クライアント側で生成したReactElementの構造が一致するかどうか判定し、一致すればDOMを再利用して一致しなければDOMを再構築する方法を採用していました。</p>

<p>v16では、サーバーサイドレンダリングで構築したDOMを、React.hydrateの際に可能な限り再利用しようとします。
ReactElementの構造が一致するかどうかの確認が、ReactElementの単位で行われるようになります。
（一致しない場合は、引き続きwarningが出力されます）
ただし、バリデーションするというよりも可能な限り再利用する方針であるため、サーバーサイドレンダリングした内容とのdiff次第では、意図しない結果となる場合があります。</p>

<ul>
<li><a href="https://github.com/facebook/react/issues/10591">https://github.com/facebook/react/issues/10591</a></li>
</ul>


<p>サーバーサイドレンダリングで意図的に異なるコンテンツを返している場合は、一度DOMをリセットする方がいいかもしれません。</p>

<p>これにより、<code>data-react-check-sum</code>だけでなく、<code>react-text</code>のコメントや<code>data-react-id</code>もHTMLに付加されなりました。</p>

<p>サーバーサイドレンダリングについては、捕捉記事書きました。</p>

<ul>
<li><a href="http://http://blog.koba04.com/post/2017/10/01/serverside-rendering-in-react-v16/">http://http://blog.koba04.com/post/2017/10/01/serverside-rendering-in-react-v16/</a></li>
</ul>


<h3>DOM Attributes</h3>

<p>これまでは、ホワイトリストで管理された属性以外は、warningを出しつつDOMには反映されなかったのですが、v16からは反映されるようになります。
これにより、ng-xxとかv-xxみたいな属性や、一部ブラウザーが実装しているけどまだ標準化されていないような属性値も使えるようになります。
ただし、on〜といった属性値については、セキュリティ的なリスクから反映されません。</p>

<p>また、属性が期待している型とは異なる値を渡した場合に、値が反映されなくなります。
例えばclassNameにfalseを渡した場合は、v15までは&#8221;false&#8221;という文字列がクラス名と設定されていましたが、v16からはwarningが出て反映されなくなります。</p>

<p>詳細は、下のブログに。</p>

<ul>
<li><a href="https://facebook.github.io/react/blog/2017/09/08/dom-attributes-in-react-16.html">https://facebook.github.io/react/blog/2017/09/08/dom-attributes-in-react-16.html</a></li>
</ul>


<h3>Bundle Size</h3>

<p>Browserifyを使ったビルドからRollupを使ったビルドに変更されて、フラットバンドルになりました。
Rollupを使って1つのモジュールとしてビルドすることで、Browserifyが付加する依存関係解決のためのコードが不要になります。
その結果、ファイルサイズの削減やブラウザー上での初回読み込みの時間が短縮されます。</p>

<p>reactとreact-domのv16をnpmからインストールすると、下記のような構造になっており、内部モジュールの構造は維持されていません。</p>

<ul>
<li>react</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">node_modules</span><span class="o">/</span><span class="nx">react</span><span class="o">/</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">LICENSE</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">README</span><span class="p">.</span><span class="nx">md</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">cjs</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">└──</span> <span class="nx">react</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">node_modules</span>
</span><span class='line'><span class="err">├──</span> <span class="kr">package</span><span class="p">.</span><span class="nx">json</span>
</span><span class='line'><span class="err">└──</span> <span class="nx">umd</span>
</span><span class='line'>    <span class="err">├──</span> <span class="nx">react</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'>    <span class="err">└──</span> <span class="nx">react</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>react-dom</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">node_modules</span><span class="o">/</span><span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">/</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">LICENSE</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">README</span><span class="p">.</span><span class="nx">md</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">cjs</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">test</span><span class="o">-</span><span class="nx">utils</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">unstable</span><span class="o">-</span><span class="kr">native</span><span class="o">-</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">unstable</span><span class="o">-</span><span class="kr">native</span><span class="o">-</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">└──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">node_modules</span>
</span><span class='line'><span class="err">├──</span> <span class="kr">package</span><span class="p">.</span><span class="nx">json</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">server</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">server</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">test</span><span class="o">-</span><span class="nx">utils</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">├──</span> <span class="nx">umd</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">unstable</span><span class="o">-</span><span class="kr">native</span><span class="o">-</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="o">-</span><span class="nx">unstable</span><span class="o">-</span><span class="kr">native</span><span class="o">-</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">├──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">│  </span> <span class="err">└──</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span><span class="p">.</span><span class="nx">production</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="err">└──</span> <span class="nx">unstable</span><span class="o">-</span><span class="kr">native</span><span class="o">-</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">js</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記の<code>cjs</code>がcommonJSのビルドが入っているディレクトリです。<code>〜.development.js</code>と<code>〜.production.min.js</code>があるのは本番用のビルドと開発用のビルドを分けるためです。
この分岐はindex.jsの中で<code>process.env.NODE_ENV</code>によって行われています。</p>

<ul>
<li><code>node_modules/react/index.js</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./cjs/react.production.min.js&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./cjs/react.development.js&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>これにより、Direct importと言われている<code>react/lib/xxx</code>のような形での内部モジュール参照が出来なくなります。これは、主にカスタムレンダラーの実装や内部の挙動を変更させるために行われており、そういったライブラリーを使っている場合には注意が必要です。</p>

<p>ちなみに、下記をwebpackとBabel(es2015とreactのprest)でビルドして、比較してみるとこんな感じでした。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="o">&lt;</span><span class="err">/div&gt;;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>v15.6.2</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">bundle</span><span class="p">.</span><span class="nx">js</span>  <span class="mi">742</span> <span class="nx">kB</span>
</span><span class='line'><span class="nx">bundle</span><span class="p">.</span><span class="nx">js</span>  <span class="mi">151</span> <span class="nx">kB</span> <span class="c1">// with `-p` option</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>16.0.0</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">bundle</span><span class="p">.</span><span class="nx">js</span>  <span class="mi">794</span> <span class="nx">kB</span>
</span><span class='line'><span class="nx">bundle</span><span class="p">.</span><span class="nx">js</span>  <span class="mi">117</span> <span class="nx">kB</span> <span class="c1">// with `-p` option</span>
</span></code></pre></td></tr></table></div></figure>


<p>production buildは小さくなってますね。</p>

<p>また、UMDビルドのディレクトリ名とファイル名が変更になっているので、CDNから利用する場合などは注意してください。</p>

<h3>License</h3>

<p>ライセンスがBSD + PATENTSからMITになりました。</p>

<ul>
<li><a href="https://code.facebook.com/posts/300798627056246/relicensing-react-jest-flow-and-immutable-js/">https://code.facebook.com/posts/300798627056246/relicensing-react-jest-flow-and-immutable-js/</a></li>
</ul>


<h3>Addons</h3>

<p>v15.5の時点で、廃止するアナウンスが出ていましたが、<code>react-addons-xxx</code>のパッケージは廃止になります。
基本的には、別パッケージになったりしているので使っているものがあれば下記で移行パスを確認してみてください。</p>

<ul>
<li><a href="https://facebook.github.io/react/blog/2017/04/07/react-v15.5.0.html#discontinuing-support-for-react-addons">https://facebook.github.io/react/blog/2017/04/07/react-v15.5.0.html#discontinuing-support-for-react-addons</a></li>
</ul>


<p>react-addons-perfに関しては、<code>?react_perf</code>をURLにつけてBrowserのPerformanceのTimelineで計測する方法になります。</p>

<ul>
<li><a href="https://facebook.github.io/react/docs/optimizing-performance.html#profiling-components-with-the-chrome-performance-tab">https://facebook.github.io/react/docs/optimizing-performance.html#profiling-components-with-the-chrome-performance-tab</a></li>
</ul>


<p>react-with-addons.jsのようなUMDビルドももう提供されません。</p>

<h2>Breaking Changes</h2>

<p>React Fiberに実装が変わったことによる、処理順の変更などが多いです。</p>

<ul>
<li>ReactDOM.renderとReactDOM.unstable_renderIntoContainerをライフサイクルメソッドの中で読んだ場合にはnullが返るようになります。</li>
<li>setStateでnullを渡した場合、更新処理が行われなくなります。</li>
<li>renderの中でのsetStateは常に更新処理が行われるようになります（以前はされない場合があったらしい）。そもそもrenderの中でsetStateを呼び出すべきではないですが。</li>
<li>setStateの第2引数のコールバックはcomponentDidMountとcomponentDidUpdateの後すぐに呼び出されるようになります。以前は全てのComponentがrenderされた後に呼び出されていました。 <strong>???以前のバージョンの挙動が確認できなかった</strong></li>
<li><code>&lt;A /&gt;</code>から<code>&lt;B /&gt;</code>に置き換えたとき、B.componentWillMountが常にA.componentWillUnmountの前に呼ばれるようになります。</li>
<li>以前は、refを更新する際のデタッチ(nullでの呼び出し)はComponentのrender関数の前に呼ばれていましたが、render関数の後に変更になります。</li>
<li>React以外によって、編集されたDOMに対して再度ReactDOM.renderを行った時にwarningが出るようになりました。この場合は一度ReactDOM.unmountComponentAtNodeでアンマウントしてから再度renderを行います。</li>
<li>componentDidUpdateのライフサイクルメソッドが第3引数としてprevContextを受け取らなくなりました。</li>
<li>ShallowRendererにunstable_batchedUpdatesはもう実装されません。</li>
</ul>


<p>下記はすでにwarningの対象で今回のバージョンで完全に削除されたものです。</p>

<ul>
<li><code>React.createClass</code>が削除されました。代わりに<code>create-react-class</code>を使います。</li>
<li><code>React.PropTypes</code>が削除されました。代わりに<code>pro-types</code>を使います。</li>
<li><code>React.DOM.xxx</code>が削除されました。代わりに<code>react-dom-factories</code>を使います。</li>
</ul>


<h2>JavaScript Environment Requirements</h2>

<p>動作環境として、<code>Map</code>と<code>Set</code>と<code>requestAnimationFrame</code>が必要になりました。
なので必要に応じてpolyfillを設定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="s1">&#39;core-js/es6/map&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="s1">&#39;core-js/es6/set&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">import</span> <span class="nx">raf</span> <span class="nx">from</span> <span class="s1">&#39;raf&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="nx">raf</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// or</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>React Fiber</h2>

<p>React Fiberについてはすでに書いたので省略しますが、v16の時点ではv15と互換性のある同期モードで動作します。
したがって、v16にあげたからといって、大きくパフォーマンスが向上したりするようなことはありません（多少のパフォーマンスが上がるかもですが）。</p>

<p>現時点では、いくつかの方法を使うことで、非同期renderingを試すことができるので紹介します。ただし、非同期rendering周りはまだ安定しておらず、コードもガンガン変わっているので注意が必要です。</p>

<h3>ReactDOM.unstable_deferredUpdates</h3>

<p><code>ReactDOM.unstable_deferredUpdates</code>で囲んだ中でのsetStateなどの更新処理は、Low Priorityとして扱われて、requestIdleCallbackを使って非同期に処理されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">unstable_deferredUpdates</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">newState</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>React.unstable_AsyncComponent</h3>

<p><code>React.unstable_AsyncComponent</code>の中で起きた更新処理はLow Priorityとして扱われるようになります。
直接Componentとして使う方法と、PureComponentのようにextends対象として使う方法があります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">AsyncComponent</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">unstable_AsyncComponent</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">AsyncComponent</span><span class="o">&gt;&lt;</span><span class="nx">App</span> <span class="o">/&gt;&lt;</span><span class="err">/AsyncComponent&gt;,</span>
</span><span class='line'>    <span class="nx">container</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">App</span> <span class="kr">extends</span> <span class="nx">AsyncComponent</span> <span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ReactDOM.flushSync</h3>

<p><code>ReactDOM.flushSync</code>で囲んだ中での更新処理は、同期(Sync)のPriorityとして扱われます。
v16ではデフォルトが同期のPriorityなので、効果ありませんが、上記のunstableなAPIの中で同期的な更新を行いたい場合に、使用します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">flushSync</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">newState</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>あとは、今後の非同期renderingに備えて、既存のStateの値を元に更新処理を行う場合は、第1引数に関数を渡す方法でのsetState呼び出しをするようにしておいた方がいいと思います。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span>
</span><span class='line'><span class="c1">// ↓↓↓</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">prevState</span> <span class="o">=&gt;</span> <span class="nx">newState</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>React Fiberでは、柔軟なスケジューリングを可能にすることで、UIのレスポンス性を向上させることが目的です。</p>

<h2>Custom Renderer</h2>

<p>Custom Rendererを実装するためのパッケージはv16には間に合いませんでしたが、下記のPRで作業中なので、気になる人はwatchしておくといいと思います。</p>

<ul>
<li><a href="https://github.com/facebook/react/pull/10758">https://github.com/facebook/react/pull/10758</a></li>
</ul>


<h2>Test Renderer</h2>

<p>主にsnapshot testingなどで使われていたTest Rendererに便利なAPIが追加されて使いやすくなりました。
Shallow Rendereは指定したComponentだけがrenderされますが、Test Rendererはツリー全体をrenderします。</p>

<p>下記のようにfind〜やfindAll〜のAPIが追加されており、インスタンスにもアクセスできるため、setStateを呼び出したりもできます。
また、Test RendererはReact Fiberに対するRendererとして実装されているため、React Fiberが提供する機能を利用できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">TestRenderer</span> <span class="nx">from</span> <span class="s1">&#39;react-test-renderer&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">Child</span> <span class="o">=</span> <span class="nx">props</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Counter</span> <span class="o">=</span> <span class="nx">props</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">App</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">section</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">bar</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">Child</span><span class="o">&gt;&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="o">&lt;</span><span class="err">/p&gt;&lt;/Child&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">bar</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})}</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">++</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">Counter</span> <span class="nx">count</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="p">}</span> <span class="o">/&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/section&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">TestRenderer</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span><span class="p">).</span><span class="nx">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// find a component by Type</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">node</span> <span class="o">=&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Child</span><span class="p">).</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;p&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">// find a component by Props</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">findByProps</span><span class="p">({</span><span class="nx">children</span><span class="o">:</span> <span class="s1">&#39;Hello&#39;</span><span class="p">}).</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;p&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// find all components by Type</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">findAllByType</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// initial state</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">instance</span><span class="p">;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">findByType</span><span class="p">(</span><span class="nx">Counter</span><span class="p">).</span><span class="nx">props</span><span class="p">.</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// click the button</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">findByType</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">).</span><span class="nx">props</span><span class="p">.</span><span class="nx">onClick</span><span class="p">();</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">findByType</span><span class="p">(</span><span class="nx">Counter</span><span class="p">).</span><span class="nx">props</span><span class="p">.</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// setState directly</span>
</span><span class='line'><span class="nx">instance</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">count</span><span class="o">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">findByType</span><span class="p">(</span><span class="nx">Counter</span><span class="p">).</span><span class="nx">props</span><span class="p">.</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">2</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>後、DOMComponentのrefに対するMockの挙動を定義することもできます。</p>

<p>Test Rendererのドキュメントを書いてみたので、そちらも参照してみてください。</p>

<ul>
<li><a href="https://facebook.github.io/react/docs/test-renderer.html">https://facebook.github.io/react/docs/test-renderer.html</a></li>
</ul>


<p>英語ですがブログも書いたのでそっちも。</p>

<ul>
<li><a href="https://medium.com/@koba04/testing-react-components-with-react-test-renderer-b4df590d0320">https://medium.com/@koba04/testing-react-components-with-react-test-renderer-b4df590d0320</a></li>
</ul>


<h2>Enzyme</h2>

<p><code>enzyme</code>も同じタイミングでv3がリリースされました。
v3からはAdapterのアーキテクチャになっており、対象とするReactのバージョンに応じたAdapterをインストールして設定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">Enzyme</span> <span class="nx">from</span> <span class="s1">&#39;enzyme&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">Adapter</span> <span class="nx">from</span> <span class="s1">&#39;enzyme-adapter-react-16&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Enzyme</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span> <span class="nx">adapter</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Adapter</span><span class="p">()</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記をNodeやMochaの<code>--require</code>オプションに設定したり、Jestの<code>setupFiles</code>に定義すれば毎回書く必要はありません。</p>

<p>これにより、今後はpreactのアプリケーションもサポートできるようになるかもしれません。</p>

<ul>
<li><a href="https://github.com/aweary/preact-enzyme-adapater">https://github.com/aweary/preact-enzyme-adapater</a></li>
</ul>


    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/blog/categories/react-dot-js/"><span class="badge">react.js</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <a href="http://b.hatena.ne.jp/entry/http://blog.koba04.com/post/2017/09/27/react-v16-changes/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.koba04.com/post/2017/09/27/react-v16-changes/" data-via="koba04" data-counturl="http://blog.koba04.com/post/2017/09/27/react-v16-changes/" >Tweet</a>
  
  
  
    <div class="fb-like" data-href="http://blog.koba04.com/post/2017/09/27/react-v16-changes/" data-send="true" data-width="100" data-show-faces="false"></div>
  
</div>


      </div>
      
      
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <p class="meta">
          
            <a class="basic-alignment left" href="/post/2017/04/25/a-state-of-react-fiber/" title="Previous Post: React Fiber現状確認">&laquo; React Fiber現状確認</a>
          
          
            <a class="basic-alignment right" href="/post/2017/10/01/serverside-rendering-in-react-v16/" title="Next Post: React v16でのサーバーサイドレンダリング">React v16でのサーバーサイドレンダリング &raquo;</a>
          
        </p>
      </div>
    </div>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2017 - koba04 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>


        </footer>
      </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'koba04log';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.koba04.com/post/2017/09/27/react-v16-changes/';
        var disqus_url = 'http://blog.koba04.com/post/2017/09/27/react-v16-changes/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=346463362115366&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
